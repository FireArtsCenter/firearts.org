---
import LoadingSpinner from './LoadingSpinner.astro';
import PlayButton from './PlayButton.astro';

interface Props {
	id: string;
	videoUrl?: string;
}

const {
	id,
	videoUrl = 'https://www.facebook.com/fireartscenterchicago/videos/10153899014125040/',
} = Astro.props;
---

<div
	id={id}
	class='video-container group relative mt-4 aspect-video w-full overflow-hidden rounded-lg bg-[#1a1a1a]'
	data-video-src={videoUrl}
>
	{/* 1. Placeholder Layer */}
	<div
		class='video-placeholder absolute inset-0 z-40 flex items-center justify-center transition-opacity duration-500'
	>
		<div
			class='absolute inset-0 scale-110 blur-lg'
			style="background-image: url('data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 1000 562%27%3E%3Crect width=%271000%27 height=%27562%27 fill=%27%232a1b2a%27/%3E%3Cpath d=%27M-50 450 L400 50 L500 100 L0 550Z%27 fill=%27%23d35400%27 fill-opacity=%270.8%27/%3E%3Crect x=%27100%27 y=%2760%27 width=%27800%27 height=%2760%27 rx=%2730%27 fill=%27%2346acc2%27/%3E%3Crect x=%270%27 y=%27250%27 width=%271000%27 height=%2770%27 fill=%27%238e44ad%27 fill-opacity=%270.7%27/%3E%3Crect x=%27350%27 y=%27480%27 width=%27600%27 height=%2760%27 rx=%2730%27 fill=%27%2327ae60%27/%3E%3Crect x=%27400%27 y=%27380%27 width=%27550%27 height=%2750%27 rx=%2725%27 fill=%27%23c0392b%27/%3E%3Cpath d=%27M300 600 L950 0 L1050 50 L400 650Z%27 fill=%27%23f1c40f%27 fill-opacity=%270.8%27/%3E%3C/svg%3E'); background-size: cover;"
		>
		</div>
		<PlayButton />
	</div>

	{/* 2. Loading State */}
	<div
		class='video-loading absolute inset-0 z-30 hidden items-center justify-center bg-[#1a1a1a]'
	>
		<LoadingSpinner />
	</div>

	{/* 3. Custom Unmute Button (Hidden until video starts) */}
	<button
		id={`unmute-${id}`}
		class='absolute right-4 bottom-4 z-50 hidden items-center gap-2 rounded-full bg-black/60 px-4 py-2 text-sm font-medium text-white backdrop-blur-md transition-all hover:bg-black/80'
	>
		<svg
			xmlns='http://www.w3.org/2000/svg'
			fill='none'
			viewBox='0 0 24 24'
			stroke-width='2'
			stroke='currentColor'
			class='h-5 w-5'
		>
			<path
				stroke-linecap='round'
				stroke-linejoin='round'
				d='M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z'
			></path>
		</svg>
		TAP FOR SOUND
	</button>

	{/* 4. Target Div for SDK Player */}
	<div
		id={`fb-player-${id}`}
		class='fb-video relative z-10'
		data-href={videoUrl}
		data-allowfullscreen='true'
		data-autoplay='true'
		data-show-captions='false'
	>
	</div>
</div>

<script is:inline define:vars={{ id }}>
	(function () {
		const container = document.getElementById(id);
		const placeholder = container?.querySelector('.video-placeholder');
		const loadingState = container?.querySelector('.video-loading');
		const unmuteBtn = document.getElementById(`unmute-${id}`);

		if (!container || !placeholder || !loadingState || !unmuteBtn) return;

		const startVideo = () => {
			placeholder.classList.add('opacity-0');
			placeholder.style.pointerEvents = 'none';
			loadingState.classList.remove('hidden');
			loadingState.classList.add('flex');

			const setupPlayer = () => {
				FB.Event.subscribe('xfbml.ready', function (msg) {
					if (msg.type === 'video' && msg.id === `fb-player-${id}`) {
						const player = msg.instance;

						// Guarantee Play by Muting
						player.mute();
						player.play();

						// Show our custom unmute button
						unmuteBtn.classList.remove('hidden');
						unmuteBtn.classList.add('flex');

						unmuteBtn.addEventListener('click', (e) => {
							e.stopPropagation();
							player.unmute();
							unmuteBtn.remove(); // Remove button once unmuted
						});

						loadingState.classList.add('opacity-0');
						setTimeout(() => {
							placeholder.remove();
							loadingState.remove();
						}, 500);
					}
				});

				FB.XFBML.parse(container);
			};

			if (window.FB) {
				setupPlayer();
			} else {
				window.fbAsyncInit = function () {
					FB.init({ xfbml: true, version: 'v25.0' });
					setupPlayer();
				};

				const script = document.createElement('script');
				script.src =
					'https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v25.0';
				script.async = true;
				script.defer = true;
				script.crossOrigin = 'anonymous';
				document.body.appendChild(script);
			}
		};

		placeholder.addEventListener('click', startVideo);
	})();
</script>
